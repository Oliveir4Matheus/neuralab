## Modal de agendamento
## üéØ Objetivo

Modificar o fluxo de **agendamento de tarefas**, garantindo:

- Centraliza√ß√£o dos par√¢metros na aba de pend√™ncias
    
- Visualiza√ß√£o e edi√ß√£o controlada via JSON
    
- Valida√ß√µes claras de obrigatoriedade
    
- Separa√ß√£o correta entre **bot√£o de acesso ao agendamento** e **modal de agendamento**
    
- Suporte a agendamento √∫nico e recorrente
    

---

## üîπ 1. Origem dos par√¢metros da tarefa

Todos os par√¢metros da tarefa a ser agendada devem vir **diretamente da aba de pend√™ncias**, conforme a tarefa selecionada.

### Par√¢metros provenientes da pend√™ncia:

- Arquivo CSV enviado
    
- Data inicial
    
- Data final
    
- C√≥digo de c√°lculo
    
- Tipo de consulta
    
- Threads
    
- Formato do arquivo
    
- Abas
    
- Tipos de e-mails dispon√≠veis
    

‚ö†Ô∏è Esses par√¢metros **n√£o devem ser redefinidos no modal**, apenas exibidos no preview.

---

## üîπ 2. Bot√£o ‚ÄúAgendar tarefa‚Äù (fora do modal)

O bot√£o que **chama o modal de agendamento** deve obedecer √†s seguintes regras:

- Deve permanecer **desabilitado** enquanto:
    
    - Algum campo obrigat√≥rio da tarefa n√£o estiver preenchido
        
- S√≥ deve ser habilitado quando:
    
    - Todos os campos obrigat√≥rios da tarefa estiverem v√°lidos e preenchidos
        

Somente ap√≥s essa valida√ß√£o o usu√°rio poder√° abrir o modal de agendamento.

---

## üîπ 3. Campo ‚ÄúTipo de Execu√ß√£o‚Äù

Campo obrigat√≥rio do tipo **select**, contendo:

- Execu√ß√£o √∫nica
    
- Execu√ß√£o recorrente
    

---

## üîπ 4. Estrutura do modal de agendamento

 `- NOVO AGENDAMENTO ------------------------------------     TIPO DE EXECU√á√ÉO (select)    +-----------------------------------------------+     DATA                      HOR√ÅRIO    +----------------------+  +---------------------+     PAR√ÇMETROS DO AGENDAMENTO    +--------------------------------------------------+    |                                                  |    |  JSON formatado (somente leitura)                |    |                                                  |    |  ‚úèÔ∏è √çcone para habilitar edi√ß√£o                  |    +--------------------------------------------------+     USU√ÅRIO S√äNIOR    +--------------------------------------------------+     SENHA S√äNIOR    +--------------------------------------------------+                   +-----------+   +-----------+                  | CANCELAR  |   | AGENDAR   |                  +-----------+   +-----------+`

---

## üîπ 5. Preview de par√¢metros

### üîí Modo padr√£o

- Preview exibido como **JSON formatado**
    
- Somente visualiza√ß√£o
    
- N√£o edit√°vel por padr√£o
    

---

### ‚úèÔ∏è Modo edi√ß√£o

- Ativado somente ao clicar no √≠cone de edi√ß√£o
    
- Permite altera√ß√£o manual dos par√¢metros
    

Antes do salvamento, o sistema deve:

- Validar se o conte√∫do √© um JSON v√°lido
    
- Validar estrutura, tipos e campos obrigat√≥rios
    
- Bloquear salvamento em caso de erro
    
- Exibir mensagem de valida√ß√£o ao usu√°rio
    

---

## üîπ 6. Formato do preview (JSON)

`{   "nomeArquivo": "arquivo.csv",   "dataInicial": "YYYY-MM-DD",    "dataFinal": "D+1",   // ou   // "dataFinal": "YYYY-MM-DD"    "codigoCalculo": 123,   "tipoConsulta": "TEXT_OU_CODIGO",   "threads": 4,   "formatoArquivo": "CSV",    "abas": [     { "nome": "aba1", "selecionado": true },     { "nome": "aba2", "selecionado": false }   ],    "emails": [     { "tipo": "RELATORIO_PROCESSAMENTO", "selecionado": true },     { "tipo": "ERRO_EXECUCAO", "selecionado": false }   ] }`

---

## üîπ 7. Regra para data final autom√°tica

Para o campo **data final da tarefa**, deve existir um **checkbox** chamado:

**‚ÄúEspecificar data final automaticamente para agendamentos‚Äù**

### Comportamento:

- Quando **desmarcado**:
    
    - O sistema utiliza a **data final fixa** no formato:
        

- - `YYYY-MM-DD`
        
- Quando **marcado**:
    
    - O sistema aceita valores relativos no formato:
        

- - `D+1 D+2 D+3 ...`
        

### Interpreta√ß√£o:

- `D` = data da execu√ß√£o
    
- `D+n` = data da execu√ß√£o + n dias
    

O sistema deve ser capaz de interpretar:

- Datas absolutas
    
- Datas relativas
    

A convers√£o ocorre **no momento da execu√ß√£o**.

---

## üîπ 8. Regras do modal de agendamento

O bot√£o **AGENDAR** (dentro do modal) s√≥ deve ser habilitado quando:

- Tipo de execu√ß√£o selecionado
    
- Data preenchida
    
- Hor√°rio preenchido
    
- Usu√°rio s√™nior preenchido
    
- Senha s√™nior preenchida
    
- Par√¢metros v√°lidos
    
- Regras de recorr√™ncia configuradas (se aplic√°vel)
    

---

## üîπ 9. Valida√ß√£o de usu√°rio e senha s√™nior

Ao tentar criar o agendamento:

- Login e senha s√™nior devem ser **validados via backend**
    
- Caso inv√°lidos:
    
    - O agendamento n√£o deve ser criado
        
    - Exibir mensagem de erro
        
- Caso v√°lidos:
    
    - Prosseguir com a cria√ß√£o do agendamento
        

---

## üîπ 10. Agendamento recorrente

Quando o usu√°rio selecionar **Execu√ß√£o recorrente**, devem ser exibidas as op√ß√µes:

- Di√°rio
    
- Semanal
    
- Mensal
    

### Regras:

- A recorr√™ncia deve possuir **1x fixado como padr√£o**
    
- N√£o deve permitir m√∫ltiplas execu√ß√µes no mesmo per√≠odo
    

---

### üîπ Recorr√™ncia semanal

Caso o usu√°rio selecione **semanal**, deve ser obrigat√≥rio escolher:

- Dia da semana da execu√ß√£o
    

Exemplo:

- Toda segunda-feira
    

---

## üîπ 11. Fluxo de agendamento

`Valida√ß√£o dos campos obrigat√≥rios da tarefa         ‚Üì Habilita bot√£o "Agendar tarefa"         ‚Üì Usu√°rio abre modal de agendamento         ‚Üì Preenche dados do agendamento         ‚Üì Valida√ß√£o de login e senha s√™nior         ‚Üì Cria√ß√£o do agendamento`

---

## üîπ 12. Comportamento esperado

- E-mails representam **tipos de e-mails**, n√£o endere√ßos
    
- Tipos s√£o consumidos por sistema externo respons√°vel pelo disparo
    
- Sistema aceita data final absoluta ou relativa (`D+n`)
    
- Convers√£o da data ocorre no momento da execu√ß√£o
    
- Bot√£o externo depende dos campos da tarefa
    
- Cria√ß√£o do agendamento depende dos campos do modal
    
- Login e senha s√™nior s√£o obrigatoriamente validados
    
- Recorr√™ncia respeita o per√≠odo configurado
    
- Nenhum par√¢metro deve ser perdido durante o fluxo
    
- Edi√ß√£o de par√¢metros deve ser validada antes do salvamento


## Vis√£o geral
-
	Todos os processos socket.io podem ser agendados atrav√©s de um bot√£o ao lado do bot√£o inciar consulta.
	Esse bot√£o permite o usu√°rio definir atrav√©s de um modal alguns par√¢metros para o agendamento como:
	* Recorr√™ncia ( √∫nica ou a cada x dias)
	* Hor√°rio: hor√°rio de execu√ß√£o
	* Credenciais do agendamento ( usuario e senha ) ( devem ser armazenados criptografados ) ( o usuario pode optar por utilizar as cred√™nciais j√° logadas ou informar outra) ( utilizar o melhor algoritmo de criptografia e tamb√©m verificar as cred√™ncias no momento do agendamento)

## Aba de agendamento
-
	Todos os agendamentos podem ser editados ( apenas  os campos recorr√™ncia, hor√°rio e credenciais do agendamento podem ser editados) ou apagados.
-
	

## Fluxo
-
	Usuario cria agendamento,  agendamento √© adicionado na aba de agendamentos e quando chega no momento da sua execu√ß√£o ele sai do status ( agendado para em execu√ß√£o e vai para abas processos  e ap√≥s sua finaliza√ß√£o um n√∫mero √© adicionado ao contador de sucessos se caso der sucesso ou erro se caso der erro na execu√ß√£o total do processo.

## Limita√ß√µes
-
	* A aba deve seguir as limita√ß√µes impostas na aba opera√ß√µes em andamento
	* N√£o posso ter dois agendamentos do mesmo processo para o mesmo h√≥rario
	* N√£o posso ter agendamento do 

## Persist√™ncia
-
	Os agendamentos criados devem ser salvos na tabela de agendamentos_processo do banco de dados

```sql
CREATE TABLE agendamentos_processo (
    id SERIAL PRIMARY KEY,
    
    -- Identifica√ß√£o do processo
    processo_id VARCHAR(100) NOT NULL,
    processo_nome VARCHAR(255) NOT NULL,
    
    -- Configura√ß√£o de recorr√™ncia
    tipo_recorrencia VARCHAR(20) NOT NULL CHECK (tipo_recorrencia IN ('unica', 'recorrente')),
    intervalo_dias INTEGER DEFAULT NULL, -- NULL para execu√ß√£o √∫nica
    horario TIME NOT NULL,
    
    -- Credenciais (criptografadas)
    usar_credenciais_logadas BOOLEAN DEFAULT FALSE,
    usuario_criptografado TEXT,
    senha_criptografada TEXT,
    
    -- Status e controle
    status VARCHAR(20) DEFAULT 'agendado' CHECK (status IN ('agendado', 'em_execucao', 'pausado')),
    proxima_execucao TIMESTAMP NOT NULL,
    
    -- Contadores
    total_sucesso INTEGER DEFAULT 0,
    total_erro INTEGER DEFAULT 0,
    
    -- Auditoria
    criado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    atualizado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    criado_por VARCHAR(100),
    
    -- Restri√ß√£o: n√£o permitir dois agendamentos do mesmo processo no mesmo hor√°rio
    CONSTRAINT unique_processo_horario UNIQUE (processo_id, horario)
);

-- Index para consultas frequentes
CREATE INDEX idx_agendamentos_proxima_execucao ON agendamentos_processo(proxima_execucao);
CREATE INDEX idx_agendamentos_status ON agendamentos_processo(status);
```
## Par√¢metros: 
Os par√¢metros do agendamento devem ser salvos em json em uma coluna chamada parametros no banco de daddos