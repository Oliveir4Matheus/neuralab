## Visao Geral

A funcionalidade de **Consulta de Pendencias** permite consultar pendencias de ponto (excecoes) de colaboradores no sistema Senior, gerando relatorios e opcionalmente sincronizando com o banco de dados Supabase.

**Pagina:** `/pendencias`
**Modulo:** Consulta de Pendencias de Ponto

---

## Fluxo da Funcionalidade

```
┌─────────────────────────────────────────────────────────────────────┐
│                    FLUXO DE CONSULTA DE PENDENCIAS                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  1. UPLOAD DO ARQUIVO CSV                                           │
│     ├─> Usuario seleciona arquivo CSV com matriculas                │
│     ├─> Sistema valida formato e colunas                            │
│     └─> Exibe quantidade de colaboradores carregados                │
│                                                                     │
│  2. CONFIGURACAO                                                    │
│     ├─> Data Inicial (obrigatorio)                                  │
│     ├─> Data Final (obrigatorio)                                    │
│     ├─> Codigo de Calculo (obtido automaticamente)                  │
│     ├─> Tipo de Consulta (com/sem pendencia ou todos)               │
│     └─> Numero de Threads (1-50)                                    │
│                                                                     │
│  3. VERIFICACAO DE SESSAO (Bug 3.1.3 Fix)                           │
│     ├─> Verifica sessao do Painel                                   │
│     │   └─> Se expirada: mostra modal de login                      │
│     └─> Verifica sessao do Senior                                   │
│         └─> Se expirada: mostra modal de login                      │
│                                                                     │
│  4. PROCESSAMENTO                                                   │
│     ├─> Para cada colaborador (em paralelo):                        │
│     │   ├─> Consulta API Senior                                     │
│     │   ├─> Extrai apuracoes do periodo                             │
│     │   ├─> Filtra situacoes excepcionais (se aplicavel)            │
│     │   └─> Calcula horas trabalhadas                               │
│     ├─> Emite progresso via Socket.IO                               │
│     └─> Permite cancelamento a qualquer momento                     │
│                                                                     │
│  5. GERACAO DE RESULTADOS                                           │
│     ├─> Gera arquivo CSV com pendencias                             │
│     ├─> Sincroniza com Supabase (opcional)                          │
│     └─> Disponibiliza download                                      │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Formato do Arquivo CSV de Entrada

O arquivo CSV deve conter uma coluna `matricula` (ou `id`) com os numeros de cadastro dos colaboradores:

### Formato Simples
```csv
matricula
12345
67890
11111
```

### Formato com Filial (recomendado para integracao com Dashboards)
```csv
matricula;filial
12345;MATRIZ
67890;FILIAL SP
11111;FILIAL RJ
```

### Formato com Mais Colunas
```csv
matricula;filial;nome;setor
12345;MATRIZ;Joao Silva;TI
67890;FILIAL SP;Maria Santos;RH
11111;FILIAL RJ;Pedro Souza;Financeiro
```

**Observacoes:**
- Separador: `;` (ponto-e-virgula) ou `,` (virgula) - detectado automaticamente
- Coluna obrigatoria: `matricula` ou `id` (case-insensitive)
- Coluna opcional: `filial` - sera incluida no relatorio como `nome_filial`
- Matriculas duplicadas sao removidas automaticamente
- O prefixo `303-1-` e adicionado automaticamente ao ID

---

## Parametros de Configuracao

| Parametro | Tipo | Obrigatorio | Descricao |
|-----------|------|-------------|-----------|
| `dataInicial` | Date | Sim | Data de inicio do periodo (YYYY-MM-DD) |
| `dataFinal` | Date | Sim | Data de fim do periodo (YYYY-MM-DD) |
| `codigoCalculo` | Number | Sim | Codigo do calculo da competencia (obtido automaticamente) |
| `numThreads` | Number | Nao | Numero de threads paralelas (padrao: 5, max: 50) |
| `filtroPendencia` | String | Nao | Tipo de consulta (ver abaixo) |
| `enviarPainel` | Boolean | Nao | Se deve sincronizar com Supabase (padrao: true) |

### Tipos de Consulta (filtroPendencia)

| Valor | Descricao |
|-------|-----------|
| `com_pendencia` | Retorna apenas dias com situacoes excepcionais (padrao) |
| `sem_pendencia` | Retorna apenas dias sem situacoes excepcionais |
| `todos` | Retorna todos os dias do periodo |

---

## API Backend

### Endpoints

#### POST /api/pendencias/upload
Upload do arquivo CSV com matriculas.

**Request:**
```
Content-Type: multipart/form-data
Body: file (arquivo CSV)
```

**Response:**
```json
{
  "success": true,
  "filename": "pendencias_1234567890.csv",
  "totalRecords": 150,
  "message": "150 colaboradores carregados"
}
```

#### POST /api/pendencias/start
Inicia o processamento de pendencias.

**Request:**
```json
{
  "dataInicial": "2025-01-01",
  "dataFinal": "2025-01-31",
  "codigoCalculo": 186,
  "numThreads": 5,
  "filtroPendencia": "com_pendencia",
  "enviarPainel": true
}
```

**Response:**
```json
{
  "success": true,
  "message": "Processamento iniciado",
  "total": 150,
  "processId": "uuid-do-processo",
  "socketRoom": "process_uuid"
}
```

#### POST /api/pendencias/cancel
Cancela o processamento em andamento.

**Request:**
```json
{
  "processId": "uuid-do-processo"
}
```

#### GET /api/pendencias/status
Retorna o status atual do processamento.

---

## API Senior

### Endpoint de Consulta

```
GET https://webp20.seniorcloud.com.br:31531/gestaoponto-backend/api/acertoPontoColaboradorPeriodo/colaborador/{303-1-MATRICULA}

Query Parameters:
  - codigoCalculo: {codigo}
  - dataInicial: YYYY-MM-DD
  - dataFinal: YYYY-MM-DD
  - gestor: S
  - orderby: -dataApuracao

Headers:
  - assertion: {token_senior}
  - Accept: application/json
```

### Estrutura da Resposta da API Senior

```json
{
  "colaborador": {
    "nome": "JOAO DA SILVA"
  },
  "apuracao": [
    {
      "dataApuracao": "2025-01-15",
      "temExcecao": true,
      "verificado": true,
      "escala": {
        "descricao": "SEG A SEX 08:00 AS 17:00"
      },
      "horario": {
        "codigo": 1234,
        "descricao": "COMERCIAL 8H"
      },
      "marcacoes": [
        {
          "origem": "E",
          "dataAcesso": "2025-01-15",
          "horaAcesso": "08:05"
        },
        {
          "origem": "E",
          "dataAcesso": "2025-01-15",
          "horaAcesso": "17:10"
        }
      ],
      "situacoesApuradas": [
        {
          "situacao": {
            "excecao": true,
            "descricao": "ATRASO"
          },
          "quantidadeHoras": "00:05"
        }
      ]
    }
  ]
}
```

**Campo `verificado`:** Indica se a pendencia foi verificada no sistema Senior. Convertido para "SIM" ou "NAO" no relatorio.

---

## Processamento dos Dados

### Codigos de Horario Especiais (Folgas)

Os seguintes codigos de horario sao considerados dias de folga e sempre sao incluidos nos resultados:

```typescript
const CODIGOS_FOLGA = [9996, 9997, 9998, 9999];
```

### Origem das Marcacoes

| Codigo | Descricao |
|--------|-----------|
| `E` | Marcacao eletronica (relogio de ponto) |
| `D` | Marcacao digitada manualmente |

Apenas marcacoes com origem `E` ou `D` sao consideradas validas.

### Calculo de Horas Trabalhadas

```typescript
// Extrai primeira e ultima marcacao do dia
const inicio = marcacoesValidas[0].horaAcesso;  // Ex: "08:05"
const termino = marcacoesValidas[marcacoesValidas.length - 1].horaAcesso;  // Ex: "17:10"

// Calcula diferenca
// Se termino < inicio, considera passagem de meia-noite
const totalHoras = calcularDiferenca(inicio, termino);  // Ex: "09:05"
```

---

## Estrutura de Dados de Saida

### Interface Pendencia

```typescript
interface Pendencia {
  idColaborador: number;      // Matricula do colaborador
  nome: string;               // Nome completo
  data: string;               // Data da apuracao (YYYY-MM-DD)
  escala: string;             // Descricao da escala
  codigoHorario: number;      // Codigo do horario
  descricaoHorario: string;   // Descricao do horario
  inicio: string;             // Primeira marcacao (HH:MM)
  termino: string;            // Ultima marcacao (HH:MM)
  totalHoras: string;         // Total trabalhado (HH:MM)
  situacao: string;           // Descricao da pendencia
  totalHorasOcorrencia: string;  // Horas da ocorrencia
  // Campos adicionais para integracao com Dashboards
  id_registro?: number;       // Numero sequencial da linha
  nome_filial?: string;       // Filial do colaborador (do CSV de entrada)
  verificado?: string;        // "SIM" ou "NAO" (da API Senior)
}
```

### Colunas do CSV Gerado

| Coluna | Tipo | Descricao |
|--------|------|-----------|
| `id_registro` | Number | Numero sequencial da linha (1, 2, 3...) |
| `id_colaborador` | Number | Matricula do colaborador |
| `nome` | String | Nome completo |
| `nome_filial` | String | Filial do colaborador (do CSV de entrada) |
| `data` | Date | Data da apuracao |
| `escala` | String | Descricao da escala |
| `codigo_horario` | Number | Codigo do horario |
| `descricao_horario` | String | Descricao do horario |
| `inicio` | Time | Primeira marcacao |
| `termino` | Time | Ultima marcacao |
| `total_horas` | Time | Horas trabalhadas |
| `situacao` | String | Descricao da pendencia |
| `total_horas_ocorrencia` | String | Horas da ocorrencia |
| `verificado` | String | "SIM" ou "NAO" - se a pendencia foi verificada |

---

## Eventos Socket.IO

O processamento emite eventos em tempo real via Socket.IO para as salas:
- `pendencias` (sala global)
- `process_{uuid}` (sala especifica do processo)
- `processes` (para atualizar lista de processos)

### Eventos Emitidos

| Evento | Payload | Descricao |
|--------|---------|-----------|
| `log` | `{ message, type, timestamp }` | Log de progresso |
| `progress` | `{ current, total, successes, errors, percentage, processId }` | Progresso atual |
| `complete` | `{ success, total, successes, errors, duration, downloadUrl }` | Conclusao |
| `error` | `{ message }` | Erro no processamento |

---

## Integracao Supabase

Quando `enviarPainel: true`, os dados sao sincronizados com a tabela `ocorrencias_ponto` do Supabase.

### Fluxo de Sincronizacao

1. **Limpar dados antigos:** `DELETE FROM ocorrencias_ponto WHERE id_colaborador != 0`
2. **Inserir novos dados:** Insere em lotes para melhor performance

### Estrutura da Tabela

```sql
CREATE TABLE ocorrencias_ponto (
  id_registro INTEGER,
  id_colaborador INTEGER,
  nome VARCHAR,
  nome_filial VARCHAR,
  data DATE,
  escala VARCHAR,
  codigo_horario INTEGER,
  descricao_horario VARCHAR,
  inicio TIME,
  termino TIME,
  total_horas TIME,
  situacao VARCHAR,
  total_horas_ocorrencia INTERVAL,
  verificado VARCHAR
);
```

---

## Concorrencia e Performance

### Pool de Concorrencia (Bug 3.1.2 Fix)

O processamento utiliza um pool de concorrencia com `p-limit` para:
- Processar multiplas requisicoes em paralelo
- Evitar sobrecarga do servidor Senior
- Renovar token automaticamente durante operacoes longas

### Configuracoes

| Parametro | Valor | Descricao |
|-----------|-------|-----------|
| `maxConcurrent` | 50 | Maximo de requisicoes simultaneas |
| `requestTimeout` | 30000ms | Timeout por requisicao |
| `tokenRefreshInterval` | 100 | Renova token a cada N requisicoes |

---

## Tratamento de Erros

### Erros de Requisicao

| Codigo HTTP | Acao |
|-------------|------|
| 200 | Sucesso - processa dados |
| 401 | Renova token e tenta novamente |
| 429 | Backoff exponencial (rate limit) |
| 500-504 | Retry com backoff exponencial |
| Timeout | Retry ate 3 tentativas |

### Backoff Exponencial

```
Tentativa 1: falha -> espera 2s
Tentativa 2: falha -> espera 4s
Tentativa 3: falha -> espera 8s
Tentativa 4: erro final (marca como falha)
```

---

## Interface do Usuario

### Secoes da Pagina

1. **Upload de Arquivo**
   - Selecao de arquivo CSV
   - Exibicao de quantidade carregada
   - Botao para baixar modelo

2. **Configuracoes**
   - Data inicial e final
   - Codigo de calculo (obtido automaticamente)
   - Tipo de consulta (filtro)
   - Numero de threads

3. **Acoes**
   - Botao "Iniciar Consulta"
   - Botao "Cancelar" (durante processamento)
   - Botao "Baixar CSV" (apos conclusao)

4. **Terminal**
   - Logs em tempo real
   - Barra de progresso
   - Contadores de sucesso/erro

### Modal de Confirmacao

Antes de iniciar, o usuario e perguntado:
> "Deseja enviar os dados apurados ao painel?"
- **Sim:** Sincroniza com Supabase
- **Nao:** Apenas gera arquivo CSV

---

## Arquivos do Sistema

### Backend

| Arquivo | Descricao |
|---------|-----------|
| `server/src/routes/pendencias.ts` | Rotas da API |
| `server/src/services/pendencias.ts` | Logica de processamento |
| `server/src/services/excel.ts` | Geracao de CSV/Excel |
| `server/src/services/supabase.ts` | Integracao Supabase |
| `server/src/utils/csv-parser.ts` | Parser de CSV |
| `server/src/utils/concurrency.ts` | Pool de concorrencia |

## Adição de funcionalidade
Com o objetivo de melhorar a eficiência das tratativas de ponto foi determinado a adição de mais um processo que ocorre após a extração das pendências na plataforma da Senior.

O processo em questão permite separar as pendências extraidas em abas diferentes e o usuario pode optar através de checkbox, quais abas deseja incluir no arquivo gerado, sendo elas:
* Todas as Pendências : aba que contém todas as pendências extraidas do ponto
* Marcações inválidas: aba que só contém pendências onde a situação é marcação inválida )
* Débito e crédito no mesmo dia: aba que só contém pendências onde o mesmo colaborador na mesma data contém um registro para débito e um para crédito)
* Horas extras acima de 6 horas: aba que só contém pendências do tipo situação crédito e que o total de horas situação é maior que 6 horas)
* Folgas trabalhadas: Aba que só contém registros onde o código de horario é 9999 ou 9996 e contém marcações
* Afastamento trabalhado: Aba que só contém registro onde a situação é igual a um desses tipos :
* Licença Paternidade
- Atestado
- Falta
- Atestado Acompanhamento
- Ausência justif. (art 473)
- Ausência sindical
- Compensa domingo
- Compensa feriado
- Débito Banco de Horas - DIA
- Emissão Credencial
- Exame periódico
- Greve
- Quebra do Relógio
- Rescisão
- Serviço Externo
- Suspensão
- Treinamento
- e possui marcação ( entrada ou saida ).
- Abandono: Colaboradores que contém mais de 10 faltas consecutivas ( deve ser desconsiderado o dia de folga, ex: 1,2,3,4,folga,5,6,7, logo esse colaborador tem 7 faltas consecutivas, ou melhor dizendo)
* Ocorrências por filial: Aba que coloca em cada coluna a quantidade de ocorrências de cada aba e em cada linha as filiais ( com uma coluna final de total)
* Ocorrências por colaborador: Aba que coloca em cada coluna a quantidade de ocorrências de cada aba e em cada linha os colaboradores ( com uma coluna final de total)
* Análise geral: essa aba deve conter diversas tabelas, uma para cada tipo de ocorrência apresentada nas abas,e as tableas classifica  as bases por quantidade de ocorrências ( do maior para o menor )

Todas as abas devem ter as colunas na mesma ordem e além do arquivo gerado contendo os dados de todas as filias, também deve haver um arquivo para cada filial.

Quando o usuário apertar em baixar arquivo automaticamente ele vai baixar o arquivo geral e os arquivos de cada base.
